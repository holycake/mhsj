#include <ansi.h>
/*
新武器思路V1.0
                 Created By Snowtu@tsrj 
*/
#include <ansi.h>
#include <weapon.h>
#include <dbase.h>
inherit EQUIP; 
inherit F_SAVE;

#define SDS_D "/d/newguai/npc/sdsd.c"

int save_item_file(string filename, string content);

mapping nn = ([
        "大夏龙雀"  : "longque",
        "寒玉八卦"  : "hanyu",
        "乾坤八卦"  : "qiankun",
        "赤铁八卦"  : "chitie",
        "九宫八卦"  : "jiugong",
        "镇岳八卦"  : "zhenyue",
        "三刃封魔"  : "fengmo",
        "火风青云"  : "huofeng",
        "广袖流仙"  : "liuxian",
        "梦华天蛇"  : "tianshe",
        "赤金斩": "chizhan",
        "幽路引魂"  : "yinhun",
        "乌金鬼头"  : "wujin",
        "五方单符"  : "wufang",
        "天劫怒斩"  : "nuzhan",
        "魔泪"  : "lei",
        "嗜血战魂"  : "shixie",        
        "破天幽炎"  : "potian",
        "流光绝影"  : "liuguang",
        "玄天神木"  : "xuantian",
        "龙御七星"  : "longyu",
        "九幽伏魔"  : "fumo",
        "血纹古"  : "xuewen",
        "罗印幽风 " : "luoyin",
        "金刚破天"  : "jingang",
        "蚀天魔"    : "shitian",
        "清月飞虹"  : "feihong",
        "磐龙破魔"  : "pomo",
        "紫金盘龙"  : "panlong",
        "碧海狂灵"  : "bihai",
        "逐日追风"  : "fengri",
        "追魂衍魔"  : "hunmo",
        "泰山宝环"  : "taishan",
        "空舞银电"  : "kongwu",
        "凤翎映月"  : "yinyue",
        "筝鸣饮血"  : "yinxue",
        "孤城万仞"  : "wanren",
        "罗天湮灭"  : "luotian",
        "华穹满月"  : "manyue",
        "无天寂灭"  : "jimie",
]);              
 
mapping a_types = ([
        "dagger"          : ({"zhua","爪","对","剖皮开骨",40}),
        "whip"         : ({"whip","鞭","条","断筋碎骨",230}),
        "spear"        : ({"spear","枪","把","刺心穿肠",240}),
        "blade"         : ({"blade","刀","把","破风断水",240}),
        "sword"         : ({"sword","剑","把","穿心刺骨",240}),
        "hammer"       : ({"hammer","锤","杆","裂地崩天",250}),
        "axe"          : ({"axe","斧","把","开天辟地",255}),
        "stick"         : ({"stick","棍","杆","碎筋断骨",280}),
]);


string query_save_file()
{
	string filename;
	object me = this_player();
	//adm/daemons/securityd中定义对此目录及子目录的写权限。
	filename = replace_string(sprintf(DROP_DIR"%c/%s/%s", me->query("id")[0],me->query("id"),query("skill_type")+"_"+query("id")), " ","_");
return filename;
}

int query_max_exp()
{
int max_exp,lvl = query("weapon_level");
if ( lvl<=0 )  max_exp = 0;
if ( lvl<10 ) max_exp = 100;
else if ( lvl<50 )  max_exp = 500;
else if ( lvl<100 )  max_exp = 1000;
else if ( lvl<200 )  max_exp = 2000;
else    max_exp = 10000;
return max_exp;
}       

void leave()
{
remove_call_out("leave");
if ( environment() && userp(environment()) )
        return;
write("\n"+this_object()->name()+HIY"化作一道金光冲天而去。\n\n"NOR);
destruct(this_object());
}

void _leave()
{
call_out("leave",2+random(5));
}               

void check_owner()
{
object ob = this_object();
object env = environment();
if ( (!userp(env) && env->is_character()) || ( env && query("owner_id") && !env->is_character() ) )
        _leave();
return;
}

int do_save(string arg)
{
	string fn, buf;
	object ob = this_object();
	object me = this_player();

	if ( !arg || !id(arg) )return 0;
	fn = (string)ob->query_save_file()+".c";
	write("文件名:"+fn+"\n");
	if (file_size(fn) != -1)
	{
		write("档案"+fn+"已存在。\n");
		return 0;
	}
	assure_file(fn);
	buf = "// ITEM Made by player(" + me->query("name") +":" + me->query("id") + ") \n//" + fn + "\n// Written by holycake\t" + ctime(time()) + "\n";
	buf += "#include <ansi.h>\n";
	buf += "#include <weapon.h>\n\n";
	buf += "inherit " + up_case(query("skill_type")) + ";\n";
	buf += "inherit F_ITEMMAKE;\n\n";
	buf += "void create()\n{\n";
	buf += "\tset_name(\""+query("name")+"\", (\{\""+query("ids")[0]+"\",\""+query("ids")[1]+"\",\""+query("ids")[2]+"\"\}));\n";
	buf += sprintf("\tset_weight(%d);\n", query_weight());
	buf += "\tset(\"unit\", \""+query("unit")+"\");\n";
	buf += "\tset(\"long\", \""+query("long")+"\");\n";
	buf += "\tset(\"value\", "+query("value")+");\n";
//	buf += "\tset(\"point\", "+(int)query("weapon_prop/damage")+");\n";
	buf += "\tset(\"material\", \""+query("material")+"\");\n";
	buf += "\tset(\"wield_msg\", \""+query("wield_msg")+"\");\n";
	buf += "\tset(\"unwield_msg\", \""+query("unwield_msg")+"\");\n";
//	buf += sprintf("\tif (! check_clone()) return;\n\trestore();\n");
	buf += sprintf("\tinit_%s(apply_damage());\n", query("skill_type"));

//设置装备属性
	if ( query("weapon_prop/damage"))
		buf += "\tset(\"weapon_prop/damage\", "+query("weapon_prop/damage")+");\n";
	if ( query("weapon_prop/dodge"))
		buf += "\tset(\"weapon_prop/dodge\", "+query("weapon_prop/dodge")+");\n";
	if ( query("weapon_prop/parry"))
		buf += "\tset(\"weapon_prop/parry\", "+query("weapon_prop/parry")+");\n";
	if ( query("weapon_prop/force"))
		buf += "\tset(\"weapon_prop/force\", "+query("weapon_prop/force")+");\n";
	if ( query("weapon_prop/literate"))
		buf += "\tset(\"weapon_prop/literate\", "+query("weapon_prop/literate")+");\n";
	if ( query("weapon_prop/unarmed"))
		buf += "\tset(\"weapon_prop/unarmed\", "+query("weapon_prop/unarmed")+");\n";

	buf += sprintf("\n\tsetup();\n}\n\n");
	buf += sprintf("string long() { return query(\"long\") + item_long(); }\n");

	if (save_item_file(fn, buf) == 1)
	{
		write("武器生成成功。");
		call_out(destruct(),1,ob);
		ob = load_object(fn);
		ob->move(me, 1);
		write("转移物品成功\n");
	}
	else
	return 0;
}

// filename 是写入文档的名称，已经包含有路径
// content 是写入文档的内容
int save_item_file(string filename, string content)
{
	rm(filename);
	if (write_file(filename, content))
	{
                VERSION_D->append_sn(filename);
		return 1;
	} else
	{
		write("写入档案(" + filename + ")时出错("+content+")，请通知巫师处理。\n");
		return 0;
	}
}
/*
int do_dest(string arg)
{
object me = this_player();
if ( !arg || !id(arg) )
        return 0;
if ( me!=environment() )
        return 0;               
if ( me->query("id")!=query("owner_id") )
        {
        if ( query("owner_id") )   write(name()+"是"+query("owner_id")+"的专属武器。\n");
        else   write(name()+"是把无主的武器。\n");
        return 1;
        }
if ( ("cmds/wiz/rm.c")->main(this_object(),query_save_file()+".o") )
        write("注销成功。\n");
me->delete("new_item/"+this_object()->query("id"));
me->save();
delete("owner_id");
delete("can_save");
delete("no_give");
delete("no_put");
delete("value");
write("ok。\n");
if ( query("weapon_level")>10 )
      destruct(this_object());
return 1;
}
*/
int restore()
{
if ( !::restore() )
        return 0;
set_name(query("name"),query("ids"));
return 1;
}               

void init()
{
check_owner();
add_action("do_save","save");
add_action("do_move","move");
add_action("do_dest","destruct");
add_action("do_promote","promote");
add_action("do_feng","feng");
if ( !environment()->is_character() )  
        return;
}

void create()
{
string name,*names,id,*ids;
string *a_t,type,long,unit;
mixed temp;
int p,we,i,k,lvl;     

names = keys(nn);
name = names[random(sizeof(names))];
id = nn[name];

a_t = keys(a_types);
type = a_t[random(sizeof(a_t))];
id = id+" "+a_types[type][0];
ids = ({id,nn[name],a_types[type][0]});
name = name+a_types[type][1]; 
unit = a_types[type][2];
long = a_types[type][3];
p = a_types[type][4];

set("skill_type", type);
set("unit",unit);
set("value",10000);
set("long","一"+unit+long+"的"+name+"。\n"NOR);
set_weight(15000);
lvl = random(10)+1;
set("weapon_level",lvl);
p = p/4+random(p/2);
p+= (random(lvl)+1)*2;
set("weapon_prop/damage", p);
i = random(p/2)+p/3;
if ( i>200 ) i = 200;
if ( random(3)==1 )
        set("weapon_prop/dodge",1+random(i)-random(i/2));
if ( random(3)==1 )
        set("weapon_prop/parry",1+random(i)-random(i/2));
if ( random(3)==1 )
        set("weapon_prop/force",1+random(i)-random(i/2));
if ( random(3)==1 )
        set("weapon_prop/literate",1+random(i)-random(i/2));
if ( random(3)==1 )
        set("weapon_prop/unarmed",1+random(i)-random(i/2));
set_name(name,ids);
set("ids",ids);
set("actions", ([
               "action":               "$N朝$n的$l狠狠就是一下",
               "damage_type":  "淤伤",
]));
setup();
}
 
string short()
{
int i = query("weapon_level");
string str;
i/= 10;
if ( i<1 ) i = 1;
if ( i<=2 )  str = YEL"普通"NOR;
else if ( i<=4 )  str = CYN"特别"NOR;
else if ( i<=6 )  str = HIW"珍贵"NOR;
else if ( i<=8 )  str = HIY"珍奇"NOR;
else str = HIW"独一无二"NOR;
if ( !query("equipped") )  return str+"的"+::short();
if ( this_object()==environment()->query_temp("secondary_weapon") ) 
        return sprintf("%25-s %s",str+"的"+::short(),"<副手武器>");
else        return sprintf("%25-s %s",str+"的"+::short(),"<主手武器>");
}

string long()
{
object who;     
int i,flag = 0;
string *tmp,type,msg = ::long();  
mapping my,his = query_entire_dbase();
msg+= "如果你想让它变成你的专属武器，可以保存它的记录(save <id>)，另外你可以注销(destruct)或升级(promote)已记录的武器。\n同时你也可以封(feng)住它的毒性。\n";
if ( query("fly") )
        msg+= name()+"上灵气逼人，仿佛随时都会按捺不住，冲天而起！\n";
if ( !who=environment() )
        return msg;
if ( !his["armor_level"] || his["armor_level"]<1 )
        his["level"]=1;
my = who->query_entire_dbase();
msg+= sprintf(CYN"\t  名称"YEL" : "NOR"%s\n"NOR,his["name"]);
if ( my && my["name"] )  msg+= sprintf(CYN"\t所有者"YEL" : "NOR HIR"%s\n"NOR,my["name"]+"("+capitalize(my["id"])+")" );
msg+= sprintf(CYN"\t  等级"YEL" : "NOR HIR"%s %d%%\n"NOR,chinese_number(his["weapon_level"]),his["weapon_level_exp"]*100/query_max_exp());
if ( his["weapon_prop"]["damage"] )
        msg+= sprintf(CYN"\t  伤害"YEL" : "NOR HIR"%d "NOR CYN"点\n"NOR,his["weapon_prop"]["damage"]);
if ( his["weapon_prop"]["parry"] )       
        msg+= sprintf(CYN"\t加招架"YEL" : "NOR HIR"%d "NOR CYN"点\n"NOR,his["weapon_prop"]["parry"]);
if ( his["weapon_prop"]["dodge"] )       
        msg+= sprintf(CYN"\t加闪避"YEL" : "NOR HIR"%d "NOR CYN"点\n"NOR,his["weapon_prop"]["dodge"]);
if ( his["weapon_prop"]["spells"] )      
        msg+= sprintf(CYN"\t加法术"YEL" : "NOR HIR"%d "NOR CYN"点\n"NOR,his["weapon_prop"]["spells"]);
if ( his["weapon_prop"]["force"] )       
        msg+= sprintf(CYN"\t加内功"YEL" : "NOR HIR"%d "NOR CYN"点\n"NOR,his["weapon_prop"]["force"]);
msg+= sprintf(CYN"\t攻击属性"YEL" : "NOR);
type = YEL"物理 "NOR;
if ( his["busy"]>0 )
        type+= HIW"冰 "NOR;
if ( his["cure"]>0 )
        type+= HIW"神圣 "NOR;
tmp = his["condition"];
if ( tmp && arrayp(tmp) )
        {
        i = sizeof(tmp);
        while(i--)
                {
                if ( tmp[i] && stringp(tmp[i]) )
                        flag++;
                }
        }
if ( flag>0 )
        type+= HIB"毒 "NOR;
msg+= type+"\n";
return msg;
}

int query_unique()  { return 1; }

int is_zhaohuan()
{
return 1;
}       

int hit_ob(object me,object target)
{
object weapon;
int i,ap,dp,damage;
mapping act;
string tmp,str,*limbs,limb,damage_type,*tt;

if ( !me || !target || !me->is_fighting(target) )
        return 0;

if ( i=query("cure")>0 && me->query("max_kee")-me->query("eff_kee")>= i && query("weapon_level")>30 )
         {
         message_vision("\n$N手中"+name()+"闪出一道柔和之光，$P浸沐其中，伤势渐渐恢复了。。。。\n",me,target);
         me->receive_curing("kee",i);
         }
if ( i=query("busy")>0 && !target->is_busy() && random(me->query_spi())>target->query("spi") && random(10)>5 && query("weapon_level")>20 )
         {
         message_vision("\n$N手中"+name()+"划出一道冰棱，$n冷不丁给冰棱带慢了脚步。\n\n",me,target); 
         if ( i>8 )  i = 8;
         target->start_busy(i);
         }
if ( random(query("weapon_level"))<35 )   return 0;
tt = query("condition");
                        if ( tt && arrayp(tt) && sizeof(tt) && query("weapon_level")>50 
  && !query("be_feng") )
        {
        i = sizeof(tt);
        while(i--)
                {
                if ( tt[i] && file_size("/daemon/condition/"+tt[i]+".c")>0 
                  && query("weapon_level")>=50 )
                        target->apply_condition(tt[i],query("weapon_level")/3);
                }
        if ( target->update_condition() )
                message_vision("\n$N手中"+name()+"带出一点绿光，$n闪避不及，绿光在他胸前一闪而没！\n\n",me,target);                                  
        }
                
weapon = me->query_temp("secondary_weapon");
if ( !weapon || !objectp(weapon) || !mapp(act=weapon->query("actions"))
  || !weapon->is_zhaohuan() )
        return 0;
ap = me->query("combat_exp")/10000;
if ( ap<10 ) ap = 10;
dp = target->query("combat_exp")/10000;
if ( dp<10 ) dp = 10;
if ( ap<random(dp/2) )
        return 0;
limbs = target->query("limbs");
limb = limbs[random(sizeof(limbs))];
tmp = weapon->query("skill_type");
if ( me->query_skill(tmp,1) )
        {
        tmp = me->query_skill_mapped(tmp);
        if ( tmp && stringp(tmp) )
                act = SKILL_D(tmp)->query_action(me,weapon);
        }
if ( !act || !mapp(act) )
        act = weapon->query("actions");
if ( !act || !mapp(act) )
        return 0;
damage = act["damage"];
damage+= me->query_temp("apply/damage");
damage+= me->query("force_factor");
damage = damage/2+random(damage);
damage-= target->query_temp("apply/armor")/2;
if ( damage<=0 )
        return 0;
str = "\n$N将"+query("name")+"交于左手，拿起"+weapon->name()+"对着$n就是一击。\n";
str+= act["action"]+"\n";
damage_type = act["damage_type"];
if ( !damage_type )
        damage_type = "淤伤";
str+= COMBAT_D->damage_msg(damage,damage_type);
str = replace_string(str,"$w",weapon->name());
str = replace_string(str,"$l",limb);
str = SDS_D->no_color_msg(str);
message_vision(str,me,target);
if ( random(me->query("force_factor"))>100 )
        target->receive_wound("kee", damage,me);
else    target->receive_damage("kee", damage,me);
return 1+random(10);
}
/*
void level_up(int v)
{
int lvl,exp,max_exp;    
mapping his = query_entire_dbase();
lvl = his["weapon_level"];
max_exp = query_max_exp();

his["weapon_level_exp"]+= v;
exp = his["weapon_level_exp"];

if ( his["weapon_prop"]["damage"]<=0 )
        his["weapon_prop"]["damage"] = 0;

if ( exp>=max_exp )
        {
        his["weapon_level_exp"] = 0;
        his["weapon_level"]+= 1;
        if ( his["weapon_prop"]["damage"] )
                {
                if ( lvl<20 )   
                        his["weapon_prop"]["damage"]+= 1+random(5);
                else if ( lvl<50 )
                        his["weapon_prop"]["damage"]+= 1+random(4);
                else if ( lvl<100 )
                        his["weapon_prop"]["damage"]+= 1+random(3);
                else    his["weapon_prop"]["damage"]+= random(3);       
                }
        if ( his["weapon_prop"]["damage"]>350 )
                his["weapon_prop"]["damage"] = 350;
        if ( his["weapon_prop"]["parry"]!=0 )
                his["weapon_prop"]["parry"]+= (random(5)-random(5));
        if ( his["weapon_prop"]["dodge"]!=0 )
                his["weapon_prop"]["dodge"]+= (random(5)-random(5));
        if ( his["weapon_prop"]["spells"]!=0 ) 
                his["weapon_prop"]["spells"]+= (random(5)-random(5));
        if ( his["weapon_prop"]["force"]!=0 )
                his["weapon_prop"]["force"]+= (random(5)-random(5));
        if ( his["weapon_prop"]["parry"]>555 )
                his["weapon_prop"]["parry"] = 555;
        if ( his["weapon_prop"]["dodge"]>555 )
                his["weapon_prop"]["dodge"] = 555;
        if ( his["weapon_prop"]["force"]>555 )
                his["weapon_prop"]["force"] = 555;
        if ( his["weapon_prop"]["spells"]>555 )
                his["weapon_prop"]["spells"] = 555;
        if ( this_object()->save() )
                {
                message_vision(HIG"$N"HIG"手中的"+name()+HIG"发出一阵绚丽的光芒！\n"NOR,environment());
                tell_object(environment(),"你的"+name()+"升级了。\n");
                }
        else    {
                                 write("升级失败！\n");
                _leave();
                }
        }
else    {
        if ( this_object()->save() )
                tell_object(environment(),"你手中的"+name()+"发出一阵绚丽的光芒！\n");
        else    {
                write("升级失败！\n");
                _leave();
                }
        }
return;         
}
*/

int apply_conditions(string cnd)
{
string *cnds = query("condition");
string *oo = ({});      
int i;

if ( !cnds || !arrayp(cnds) )
        cnds = ({});
i = sizeof(cnds);         
while(i--)
        if ( cnds[i] )  
                oo+= ({cnds[i]});
oo+= ({cnd});
set("condition",oo);
return 1;        
}
/*
int do_feng(string arg)
{
object ding,ob = this_object();
object me = this_player();
string type,tmp;

if ( !arg || !id(arg) )
        return 0;
if ( !present(ob,me) )
        return 0;
if ( me->is_busy() || me->query("mana")<500 || me->query("sen")<100 )
        {
        write("你目前的状态无法封住"+name()+"的毒性。\n");
        return 1;
        }                               
if ( ob->query("equipped") )
        {
        write("你得先将"+name()+"卸除。\n");
        return 1;
        }
if ( ob->query("be_feng") )
        {
        ob->delete("be_feng");
        write("你将"+name()+"的毒性解封了。\n");
        }
else    {
        ob->set("be_feng",1);
        write("你将"+name()+"的毒性封起了。\n");
        }
me->add("mana",-500);
ob->save();
return 1;
}

int do_promote(string arg)
{
object ding,ob = this_object();
object me = this_player();
string type,tmp;

if ( !arg || !id(arg) )
        return 0;
if ( !present(ob,me) )
        return 0;
if ( me->is_busy() || me->query("force")<100 || me->query("kee")<100 )
        {
        write("你目前的状态无法炼制"+name()+"。\n");
        return 1;
        }                               
if ( ob->query("equipped") )
        {
        write("你得先将"+name()+"卸除。\n");
        return 1;
        }
if ( !ob->save() )
        {
        write(name()+"目前的状态无法炼制。\n");
        return 1;
        }                               
ding = present("zhurong ding",me);
if ( !ding || !objectp(ding) || !ding->is_zhaohuan() )
        {
        write("你需要先准备祝融鼎来修炼"+name()+"。\n");
        return 1;
        }
if ( !ding->check_item() )
        {
        write("你的祝融鼎尚未准备好炼制"+name()+"的材料。\n");
        return 1;
        }
if ( ( me->query("新任务/门派挑战/num")<9 
  || !me->query("新任务/门派挑战/千面怪") )
  && query("weapon_level")<20  )
        {
        write("你门派挑战尚未功德圆满，不能炼制"+name()+"。\n");
        return 1;
        }
if ( query("weapon_level")>255 )
          {
          write("你的"+name()+"已经升至最高级了。\n");
          return 1;
          }
tmp = me->query_skill_mapped("force");
if ( !tmp || !stringp(tmp) )
        tmp = "内功";
else    tmp = to_chinese(tmp);          
message_vision("$N将"+name()+"慢慢插入"+ding->name()+"中，运起"+tmp+"开始炼制"+name()+"。\n",me);
me->start_busy(3);
me->add("force",-80);
me->receive_damage("kee",88,me);
ding->information(me,ob);
return 1;
}
*/